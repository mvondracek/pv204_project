import javacard.framework.ISO7816;
import javax.smartcardio.CommandAPDU;
import javax.smartcardio.ResponseAPDU;
import opencrypto.jcmathlib.ECExample;
import opencrypto.test.CardManager;
import opencrypto.test.PerfTests;
import opencrypto.test.RunConfig;
import opencrypto.test.Util;
import static opencrypto.test.Util.hexStringToByteArray;
import opencrypto.test.TestClient;
import static opencrypto.test.TestClient.APDU_CLEANUP;
import static opencrypto.test.TestClient.OPENCRYPTO_UNITTEST_APPLET_AID;
import static org.testng.Assert.*;
import org.testng.annotations.AfterClass;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.BeforeClass;
import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;

/**
 *
 * @author Petr Svenda
 */
public class JCMathLibTests {
    static final int SMALLTEST_NUM_REPEATS = 10;
    static final int LARGETEST_NUM_REPEATS = 1000;
    
    public JCMathLibTests() {
    }

    @Test
    public void openCrypto_smallTest_simulator() throws Exception {
        bignat_tests(SMALLTEST_NUM_REPEATS, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
        integer_tests(SMALLTEST_NUM_REPEATS, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
        ecc_tests(SMALLTEST_NUM_REPEATS, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
    }    
    @Test
    public void openCrypto_largeTest_simulator() throws Exception {
        bignat_tests(LARGETEST_NUM_REPEATS, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
        integer_tests(LARGETEST_NUM_REPEATS, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
        ecc_tests(LARGETEST_NUM_REPEATS, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
    }
    @Test
    public void openCrypto_smallTest_realCard() throws Exception {
        bignat_tests(SMALLTEST_NUM_REPEATS, RunConfig.CARD_TYPE.PHYSICAL);
        integer_tests(SMALLTEST_NUM_REPEATS, RunConfig.CARD_TYPE.PHYSICAL);
        ecc_tests(SMALLTEST_NUM_REPEATS, RunConfig.CARD_TYPE.PHYSICAL);
    }
    @Test 
    public void openCrypto_problemInputs_simulator() throws Exception {
        bignat_problemInputs(RunConfig.CARD_TYPE.JCARDSIMLOCAL);
        ecc_problemInputs(RunConfig.CARD_TYPE.JCARDSIMLOCAL);
    }
    @Test
    public void openCrypto_problemInputs_realCard() throws Exception {
        bignat_problemInputs(RunConfig.CARD_TYPE.PHYSICAL);
        ecc_problemInputs(RunConfig.CARD_TYPE.PHYSICAL);
    }    
    
    public void bignat_tests(int numRepeats, RunConfig.CARD_TYPE cardType) throws Exception {
        TestClient testClient = new TestClient();
        RunConfig runCfg = RunConfig.getConfig(true, false, false, numRepeats, cardType);
        assertTrue(testClient.OpenCryptoFunctionalTests(runCfg));
        assertTrue(runCfg.failedTestsList.isEmpty());
    }
    public void integer_tests(int numRepeats, RunConfig.CARD_TYPE cardType) throws Exception {
        TestClient testClient = new TestClient();
        RunConfig runCfg = RunConfig.getConfig(false, true, false, numRepeats, cardType);
        assertTrue(testClient.OpenCryptoFunctionalTests(runCfg));
        assertTrue(runCfg.failedTestsList.isEmpty());
    }
    public void ecc_tests(int numRepeats, RunConfig.CARD_TYPE cardType) throws Exception {
        TestClient testClient = new TestClient();
        RunConfig runCfg = RunConfig.getConfig(false, false, true, numRepeats, cardType);
        assertTrue(testClient.OpenCryptoFunctionalTests(runCfg));
        assertTrue(runCfg.failedTestsList.isEmpty());
    }

    
    void testAPDU(CardManager cardMngr, String input, String expectedOutput) {
        try {
            ResponseAPDU response = cardMngr.transmit(new CommandAPDU(hexStringToByteArray(input)));
            if (response.getSW() == (ISO7816.SW_NO_ERROR & 0xffff)) {
                if (!expectedOutput.isEmpty()) {
                    byte[] data = response.getData();
                    String output = Util.bytesToHex(data);
                    assertTrue(expectedOutput.equalsIgnoreCase(output), "Result provided by card mismatch expected");
                }
            }
            else {
                assertTrue(false, String.format("Card failed with 0x%x", response.getSW()));
            }                
        }
        catch (Exception e) {
            e.printStackTrace();
            assertTrue(false, "Card transmit failed with execption");
        }
    }
    
    public void ecc_problemInputs(RunConfig.CARD_TYPE cardType) {
        try {
            // Prepare card
            RunConfig runCfg = RunConfig.getConfig(false, false, false, 1, cardType);
            CardManager cardMngr = new CardManager(true, OPENCRYPTO_UNITTEST_APPLET_AID);
            assertTrue(cardMngr.Connect(runCfg), "Failed to connect to card");
            cardMngr.transmit(new CommandAPDU(PerfTests.PERF_COMMAND_NONE));
            cardMngr.transmit(new CommandAPDU(APDU_CLEANUP));

            
            //
            // EC failure cases
            //
            
            
            /* EC ADD
             --> B0420000820405AC28C3A153AA18E5F7B08C7C6992F517430CBCCBCA0DCAF7285599E495F7777CA85E1C9EC671D182DFEBEDE489FB625596CBD5886F649B23A0B2A982C77ABD045A55EC838109C2157862B4508421C288EDDD6CB63B4082763E59683E716C093033C0E616D1826904C5E91BB73A81A0DEF9042C621100E53CDBC9F92298E0FACD
             <-- 049BC398A6EC46C801613DABD1EA4418901DF881EA4001677408208E85E1B8C87D3541C50B64BA9C6326746F177C10BFF061877725B5575678E49041F7E3254284 9000 (65) [1 ms]
             Expected: 04C4F9B065A7B13806F5653333AE5F79F009029F897A3C7BB67FBBE4740835BA21209D14FF7D9BFE018CA4875C64ED6461732D6E49F4684691CCA825D02740A79D
             Obtained: 049BC398A6EC46C801613DABD1EA4418901DF881EA4001677408208E85E1B8C87D3541C50B64BA9C6326746F177C10BFF061877725B5575678E49041F7E3254284
             */
            testAPDU(cardMngr, "B0420000820405AC28C3A153AA18E5F7B08C7C6992F517430CBCCBCA0DCAF7285599E495F7777CA85E1C9EC671D182DFEBEDE489FB625596CBD5886F649B23A0B2A982C77ABD045A55EC838109C2157862B4508421C288EDDD6CB63B4082763E59683E716C093033C0E616D1826904C5E91BB73A81A0DEF9042C621100E53CDBC9F92298E0FACD",
                    "04C4F9B065A7B13806F5653333AE5F79F009029F897A3C7BB67FBBE4740835BA21209D14FF7D9BFE018CA4875C64ED6461732D6E49F4684691CCA825D02740A79D");

            /* requires complete reallocation of ECCurve and ECPoint with new G
             ECPoint_double with random point:            
             Random ECPoint == G: 04E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A
             --> B04500004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A
             <-- 9000 [2002 ms]
             -- > B04100004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A
             cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B04500004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A")));
             cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B04100004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A")));
             */
            testAPDU(cardMngr, "B04500004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A",
                    "");
            testAPDU(cardMngr, "B04100004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A",
                    "");


            /* OK EC point add - OutOfBound exception on j2e            (fixed, caused by rease of ECCurve.pBN after card reset)
             -- > B04200008204BF72189A853910F6E09B9AAA7E88FF3E077FFB308C6A3F04D9B2BE394368A63E6C75201A93FE46D00B9C4A9CA941E45B9F134C9ABEC69987A18040A4A982ACCE043C6CF897C243273248B982EB5BAC53AA9C7DA651770A849E8F0BC3ADDAFFE462FD19D33F56E5F0238824D0CCA999B0208D9BDBC5A92B2CC7F4BFA1F57E0D0DE1
             < --FF02 [156 ms]
             testAPDU(cardMngr, "B04500004104E1949A6DC59211505B7D120A3506EF09DB472C2A9E767C686396EA72367332F1D888E07010C8EC8EB02F8477BE426995978F342169E3CE500735666821AB2A3A",
                    "");
            */
            testAPDU(cardMngr, "B04200008204BF72189A853910F6E09B9AAA7E88FF3E077FFB308C6A3F04D9B2BE394368A63E6C75201A93FE46D00B9C4A9CA941E45B9F134C9ABEC69987A18040A4A982ACCE043C6CF897C243273248B982EB5BAC53AA9C7DA651770A849E8F0BC3ADDAFFE462FD19D33F56E5F0238824D0CCA999B0208D9BDBC5A92B2CC7F4BFA1F57E0D0DE1",
                    "");

            /* OK EC scalar_Point Multiplication - good X and Y           
             --> B04320006178A124A8A42D09E7A7CE086BB0498A62D643F4240E6BCE8678FC80E761E18D8F 046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5
             < --045452BF4C01A2B8945B5D0571AFE67FCB4F4212AFEA563430853578B102AAFAE7 C5A8AA4D177A6690932ADDE5D59DEEDA6C2040CDCF8851AF91E89EA685EA37D9 9000 (65)
             true
             04
             5452BF4C01A2B8945B5D0571AFE67FCB4F4212AFEA563430853578B102AAFAE7 
             C5A8AA4D177A6690932ADDE5D59DEEDA6C2040CDCF8851AF91E89EA685EA37D9
            
             My response:04
             5452BF4C01A2B8945B5D0571AFE67FCB4F4212AFEA563430853578B102AAFAE7
             3A5755B1E88599706CD5221A2A62112593DFBF333077AE506E1761597A15C826            

             Valid Y : C5A8AA4D177A6690932ADDE5D59DEEDA6C2040CDCF8851AF91E89EA685EA37D9           
             My inv Y: 3A5755B1E88599706CD5221A2A62112593DFBF333077AE506E1761597A15C826
            
             -->  B043200061464C1264592B74EC69C157549A3419E82E52A7FA991DF4DBB16651A1E058E42B046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5
             <-- 04 4DDED9788EBD7BDC7CFE2E0E2841D1A82BECAC1A11BBF23D0BDB967DC31052F8 385C7026EE71E69394040CC61E2BABF369BAD256BCFFBD5769575493A1061D59 9000 (65)
             true
            */
            testAPDU(cardMngr, "B04320006178A124A8A42D09E7A7CE086BB0498A62D643F4240E6BCE8678FC80E761E18D8F046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",
                    "045452BF4C01A2B8945B5D0571AFE67FCB4F4212AFEA563430853578B102AAFAE7C5A8AA4D177A6690932ADDE5D59DEEDA6C2040CDCF8851AF91E89EA685EA37D9");
            
            /*            
             OK EC scalar_Point Multiplication - good X and bad Y - needed recomputation 
             --> B04320006159D54E15D501C29314527B7120149203558A03D56F9B3AE76E343B67DFBB175F 046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5<
             -- 6700
             false
             */
            testAPDU(cardMngr, "B04320006159D54E15D501C29314527B7120149203558A03D56F9B3AE76E343B67DFBB175F046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",
                    "");
            testAPDU(cardMngr, "B04320006178A124A8A42D09E7A7CE086BB0498A62D643F4240E6BCE8678FC80E761E18D8F046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",
                    "");
            testAPDU(cardMngr, "B043200061464C1264592B74EC69C157549A3419E82E52A7FA991DF4DBB16651A1E058E42B046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",
                    "");
            testAPDU(cardMngr, "B04320006159D54E15D501C29314527B7120149203558A03D56F9B3AE76E343B67DFBB175F046B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C2964FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",
                    "");
            
            /*
             EC Point Double: GD60 provides incorrect answer - KA.generateSecrets returns only first 20 bytes instead of whole 32
             --> B041000041040016A52AED459400766FCC032B9C6049E2130E5F70E3BED5F3E0F42310F6AEDBF9A027D9D16844E5D818A199145D7B30822800351D514F36AEF69EEB2585718B
             <-- 040000000000000000000000002465E5D03C7C2EA823EF15E660845D305D60BEEF03698F5BC1E4AD04B2B1D95F37D67FE8A0DD8DCD7E538F0EC0DDBC866584B85A 9000 (65) [3188 ms]
             Expected: 042465E5D03C7C2EA823EF15E660845D305D60BEEFEB69ECDB4A895F71F0AED9BD863EA5BEF9B08EDD11DF771651002DFC4ABF62D3948853236C150AD92DC8CB05
             Obtained: 040000000000000000000000002465E5D03C7C2EA823EF15E660845D305D60BEEF03698F5BC1E4AD04B2B1D95F37D67FE8A0DD8DCD7E538F0EC0DDBC866584B85A
             false (3188 ms)
             */
            testAPDU(cardMngr, "B041000041040016A52AED459400766FCC032B9C6049E2130E5F70E3BED5F3E0F42310F6AEDBF9A027D9D16844E5D818A199145D7B30822800351D514F36AEF69EEB2585718B",
                    "042465E5D03C7C2EA823EF15E660845D305D60BEEFEB69ECDB4A895F71F0AED9BD863EA5BEF9B08EDD11DF771651002DFC4ABF62D3948853236C150AD92DC8CB05");

            /*
             EC Point Double: 
             --> B041000041041A200A8CF6CAF55FBFBA77C85F4B3D3F85BC3F94CC51807EE3F63A5FCED1815CF5DF4CD5A654B5E9A95499391200A5B61B6FDF9BCDFC984F0623DCDEBCC05F00
             javax.smartcardio.CardException: sun.security.smartcardio.PCSCException: Unknown error 0x8010002f        
             */
            testAPDU(cardMngr, "B041000041041A200A8CF6CAF55FBFBA77C85F4B3D3F85BC3F94CC51807EE3F63A5FCED1815CF5DF4CD5A654B5E9A95499391200A5B61B6FDF9BCDFC984F0623DCDEBCC05F00",
                    "");

            /*
             OK EC Point Double: incorrect last digit of X (both jcardsim and j2e) - x_p length was 31, from_byte_array read only subpart
             --> B0410000410452FA006F9A47EF2EAC460205BBA14C2448BA0B63FD4CFFB2F27AD98A06086B290892F24916E949E83624781286D81BF04FE1D11E7662D79FF0820A6DCFDA9E80
             <-- 041205F5BBC2C5FF101CD915357F771CC44E33280238EA4E1BC05CF888520B560066C77E60CA3AABD17AD98D95905C3C51E2FBD30FF6747278B5F320B917B13249 9000 (65) [1289 ms]
             Expected: 041205F5BBC2C5FF101CD915357F771CC44E33280238EA4E1BC05CF888520B5682AEF9A914E2293C1498DB0D75EBEFCE57C95DEA3B183D7C5631EFE62B6A39A8F2
             Obtained: 041205F5BBC2C5FF101CD915357F771CC44E33280238EA4E1BC05CF888520B560066C77E60CA3AABD17AD98D95905C3C51E2FBD30FF6747278B5F320B917B13249
             false (1289 ms)
             */
            testAPDU(cardMngr, "B0410000410452FA006F9A47EF2EAC460205BBA14C2448BA0B63FD4CFFB2F27AD98A06086B290892F24916E949E83624781286D81BF04FE1D11E7662D79FF0820A6DCFDA9E80",
                    "041205F5BBC2C5FF101CD915357F771CC44E33280238EA4E1BC05CF888520B5682AEF9A914E2293C1498DB0D75EBEFCE57C95DEA3B183D7C5631EFE62B6A39A8F2");

            /*
             OK EC scalar_Point Multiplication:  lopps forever
             scalar: 0D4E3C7BD96EBFF859159CC293AD81916C25C5D046D01A4056385D4F6539C327
             point : 0419E49497625450C8DBDB9E26648C3BB4A8C452FD75B2A573B0B7DC138416D0276E11FAB26D1017EA8E66D72D263AD9D79A25218852422AEB6340EF9625C3F3FF
             expect: 048EF036EB99F5F4DC108523C05EAF8783395E0FDA44F47A5879CA2DB0E2C1AB93FBB16CC35A2A3E0B964784ED3CC8128CB772028683A52ECB835E8C8B35016FF3
             --> B0432000610D4E3C7BD96EBFF859159CC293AD81916C25C5D046D01A4056385D4F6539C3270419E49497625450C8DBDB9E26648C3BB4A8C452FD75B2A573B0B7DC138416D0276E11FAB26D1017EA8E66D72D263AD9D79A25218852422AEB6340EF9625C3F3FF

             */
            testAPDU(cardMngr, "B0432000610D4E3C7BD96EBFF859159CC293AD81916C25C5D046D01A4056385D4F6539C3270419E49497625450C8DBDB9E26648C3BB4A8C452FD75B2A573B0B7DC138416D0276E11FAB26D1017EA8E66D72D263AD9D79A25218852422AEB6340EF9625C3F3FF",
                    "048EF036EB99F5F4DC108523C05EAF8783395E0FDA44F47A5879CA2DB0E2C1AB93FBB16CC35A2A3E0B964784ED3CC8128CB772028683A52ECB835E8C8B35016FF3");


            /* OK EC Point Add: 
             --> B0420000820405AC28C3A153AA18E5F7B08C7C6992F517430CBCCBCA0DCAF7285599E495F7777CA85E1C9EC671D182DFEBEDE489FB625596CBD5886F649B23A0B2A982C77ABD045A55EC838109C2157862B4508421C288EDDD6CB63B4082763E59683E716C093033C0E616D1826904C5E91BB73A81A0DEF9042C621100E53CDBC9F92298E0FACD
             <-- 049BC398A6EC46C801613DABD1EA4418901DF881EA4001677408208E85E1B8C87D3541C50B64BA9C6326746F177C10BFF061877725B5575678E49041F7E3254284 9000 (65) [1 ms]
             Expected: 04C4F9B065A7B13806F5653333AE5F79F009029F897A3C7BB67FBBE4740835BA21209D14FF7D9BFE018CA4875C64ED6461732D6E49F4684691CCA825D02740A79D
             Obtained: 049BC398A6EC46C801613DABD1EA4418901DF881EA4001677408208E85E1B8C87D3541C50B64BA9C6326746F177C10BFF061877725B5575678E49041F7E3254284
             false (1 ms)
*/            
            testAPDU(cardMngr, "B0420000820405AC28C3A153AA18E5F7B08C7C6992F517430CBCCBCA0DCAF7285599E495F7777CA85E1C9EC671D182DFEBEDE489FB625596CBD5886F649B23A0B2A982C77ABD045A55EC838109C2157862B4508421C288EDDD6CB63B4082763E59683E716C093033C0E616D1826904C5E91BB73A81A0DEF9042C621100E53CDBC9F92298E0FACD",
             "04C4F9B065A7B13806F5653333AE5F79F009029F897A3C7BB67FBBE4740835BA21209D14FF7D9BFE018CA4875C64ED6461732D6E49F4684691CCA825D02740A79D");
/*            
             EC Point Add: 
             --> B042000082040EAD4E4EF0C7201D154C945143F8E3BEBFA727FC1ADA3E242AF765B8CBBEB31E0D9D674C9C46CED3814AADF3B26B539910BE119798760880253CCB178FA48053045722EF49138CBA824475CC788A90F354B775C6BAAAA6801A97D24AB4483D62D3003CCA6B720A46891ED1BBD3EB9A72D272DF673F841BFEB63232C5B1E3E99AB8
             <-- 04441E088C277CD642FC21CC3810BEB8F9255CCCDBEDCD1F8E68FC103B9BCB9E1EDCE877B4789D00EB8322E3B5031764F4D2BE21E285663CBCF6A8E1FB58AFDB81 9000 (65) [1 ms]
             Expected: 04A9D9B0AD10D7F612979383633355717C957F8B05DC328F9F0A62155394B3B1C28DCCAA66F5F90E18D53DADF7C1307BCD6474FE863EA4C8CF55869CAFDED8EB03
             Obtained: 04441E088C277CD642FC21CC3810BEB8F9255CCCDBEDCD1F8E68FC103B9BCB9E1EDCE877B4789D00EB8322E3B5031764F4D2BE21E285663CBCF6A8E1FB58AFDB81
             false (1 ms)
*/            
            testAPDU(cardMngr, "B042000082040EAD4E4EF0C7201D154C945143F8E3BEBFA727FC1ADA3E242AF765B8CBBEB31E0D9D674C9C46CED3814AADF3B26B539910BE119798760880253CCB178FA48053045722EF49138CBA824475CC788A90F354B775C6BAAAA6801A97D24AB4483D62D3003CCA6B720A46891ED1BBD3EB9A72D272DF673F841BFEB63232C5B1E3E99AB8",
             "04A9D9B0AD10D7F612979383633355717C957F8B05DC328F9F0A62155394B3B1C28DCCAA66F5F90E18D53DADF7C1307BCD6474FE863EA4C8CF55869CAFDED8EB03");
/*            
             EC Point Add: 
             --> B0420000820454976787E8049158A46C5EF2ED572F16F52ACAD8DD70646039D1B8CF8FA36D3A1BFDF1F8ABFAE4061E3715C231F12CAFE6CB57CB6104DEC577293643F5F5EE3A04A444355F2F44BFFABB6DA1454722C4ABBC2FA74A672CE6693BE158B9CBBE5BC9EB4A1EC721B53E27AEAA2055A68F787D2DDE14942BD03141A4B8728140EEF4FB
             <-- 04A41D315A84BB27E72AD52AB936668CA421A738D46CDFAF150223003D49F887300D52B34F9E5F2C7DEC87AC96D26303F593F9014396E2655C78C7ACB3EF90E472 9000 (65) [1 ms]
             Expected: 043BC15BE5F752B3270DB0AEF2BCF0ECBDB5788F88E614323068C4C4886B43914C22E167683B32959831196D41880C9F8C596760861A86F80D01460CB58D866C09
             Obtained: 04A41D315A84BB27E72AD52AB936668CA421A738D46CDFAF150223003D49F887300D52B34F9E5F2C7DEC87AC96D26303F593F9014396E2655C78C7ACB3EF90E472
             false (1 ms)
             cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B0420000820405AC28C3A153AA18E5F7B08C7C6992F517430CBCCBCA0DCAF7285599E495F7777CA85E1C9EC671D182DFEBEDE489FB625596CBD5886F649B23A0B2A982C77ABD045A55EC838109C2157862B4508421C288EDDD6CB63B4082763E59683E716C093033C0E616D1826904C5E91BB73A81A0DEF9042C621100E53CDBC9F92298E0FACD")));
*/
            testAPDU(cardMngr, "B0420000820454976787E8049158A46C5EF2ED572F16F52ACAD8DD70646039D1B8CF8FA36D3A1BFDF1F8ABFAE4061E3715C231F12CAFE6CB57CB6104DEC577293643F5F5EE3A04A444355F2F44BFFABB6DA1454722C4ABBC2FA74A672CE6693BE158B9CBBE5BC9EB4A1EC721B53E27AEAA2055A68F787D2DDE14942BD03141A4B8728140EEF4FB",
                    "043BC15BE5F752B3270DB0AEF2BCF0ECBDB5788F88E614323068C4C4886B43914C22E167683B32959831196D41880C9F8C596760861A86F80D01460CB58D866C09");

/*            
             EC Point Double: (standard G)
             --> B0410000410400047AD7AD297E94E6EA398FB2925E130C3F4710D1963728AA6BCCDB51B9EEDAE564BAA1B1574241FB2BD0AB7570C9ADE06A11E2757D28BE1A08575C894BFBB3
             <-- 04F1A9E97B58F3B52FB0B9733C1E3C62E254A5F8597E9FEC3657F395900B74ABF14B9D3149308739C80142AF440EF763BFF949CA92308FC49A3A84CB9653D70933 9000 (65) [0 ms]
             Expected: 04F1A9E97B58F3B52FB0B9733C1E3C62E254A5F8597E9FEC3657F395900B74ABF1 F042DC11CE0339B29F03F77FC0A36BBBE3DDF62F6B37579AA9EE4560E3A03D3F
             Obtained: 04F1A9E97B58F3B52FB0B9733C1E3C62E254A5F8597E9FEC3657F395900B74ABF1 4B9D3149308739C80142AF440EF763BFF949CA92308FC49A3A84CB9653D70933
             false (0 ms)
*/
            testAPDU(cardMngr, "B0410000410400047AD7AD297E94E6EA398FB2925E130C3F4710D1963728AA6BCCDB51B9EEDAE564BAA1B1574241FB2BD0AB7570C9ADE06A11E2757D28BE1A08575C894BFBB3",
                    "04F1A9E97B58F3B52FB0B9733C1E3C62E254A5F8597E9FEC3657F395900B74ABF1F042DC11CE0339B29F03F77FC0A36BBBE3DDF62F6B37579AA9EE4560E3A03D3F");


            /*
             EC scalar_Point Multiplication: 
             --> B04321006200E805E802BFECEE919B3D3BD83C7B52A5D5354C4C06898054B976FAB1D35A109104C449C202B3781B0F689894723BB9EB96DA13D51F596824831FDC83A9FD18AB3FE0E26FCE752E7C8CDC0EB5AF70342B7ECFB4D240C1D70333F80552CDAF14B4FE
             <-- 0489857CC9D4CB3BBF49D11C324E0A9EDF259335BF5498BECC43A62E5E757EB0BAFFE154BA84053CE85AB62083E6E7E67029B1A7AC66EF5BEB1A361E5B3865655B 9000 (65) [11 ms]
             true (11 ms)
*/            
            testAPDU(cardMngr, "B04321006200E805E802BFECEE919B3D3BD83C7B52A5D5354C4C06898054B976FAB1D35A109104C449C202B3781B0F689894723BB9EB96DA13D51F596824831FDC83A9FD18AB3FE0E26FCE752E7C8CDC0EB5AF70342B7ECFB4D240C1D70333F80552CDAF14B4FE",
             "0489857CC9D4CB3BBF49D11C324E0A9EDF259335BF5498BECC43A62E5E757EB0BAFFE154BA84053CE85AB62083E6E7E67029B1A7AC66EF5BEB1A361E5B3865655B");

            /*        
             EC Point Add: will trigger processing where m_ecHelper.y_r.length() < this.TheCurve.COORD_SIZE
             -- > B04200008204A0963A315E016F89E8038E95E3FC3BE33F8A84D6BA2650C505473FDAB15C57594E0372E2ED17DF269536BFD615B3C29DAAB44244610DE156D3FCE5B96F1BEADB048A35B870E4ABC095D0CF6F6B0DE9989A7053A2B7125E20CE5C4B8FFBC2E14FE2A5CFD0E6D397412F3811A76E2EFC4EDB57AD6CEFD79DBCD592D139CB25FBDBED        
             Expected: <-- 0456A4E425F6D55978A7FF2E0ABEFCF56175B6B91E133D5DD1174BC20C320A275DB2730F5F3FEC7E9D811351B5B04A8A4CD31AA31908A06B9BAB028669D97FE2B0 9000 (65) [100849 ms]
             */
            testAPDU(cardMngr, "B04200008204A0963A315E016F89E8038E95E3FC3BE33F8A84D6BA2650C505473FDAB15C57594E0372E2ED17DF269536BFD615B3C29DAAB44244610DE156D3FCE5B96F1BEADB048A35B870E4ABC095D0CF6F6B0DE9989A7053A2B7125E20CE5C4B8FFBC2E14FE2A5CFD0E6D397412F3811A76E2EFC4EDB57AD6CEFD79DBCD592D139CB25FBDBED",
                    "0456A4E425F6D55978A7FF2E0ABEFCF56175B6B91E133D5DD1174BC20C320A275DB2730F5F3FEC7E9D811351B5B04A8A4CD31AA31908A06B9BAB028669D97FE2B0");
            
    /*
             EC Point Add:
             --> B0420000820433C418ABD0ACDB00A7D5D57BFA2084D813BE8E63F99C0954F2041C2E0C2DD5ED40FB5B84C0BDFD16F5CA243422942852438C48CE016751FB0208C6744DE2F75D044EDEBB1CE07F3CA1E1CB0C3ED1F0B6877F709BE567C37C323325CCA9C1E1927854E55A412F53831A970BA0CF8F165EC51BC83C10E95E5F02328F8419A0E40043
             <-- 041EB4C36AC69962332EE1AB5DF684B693DF6E220C3BBFA0527A035CAC976E6BE249590269FE030B34A21446C0A0299D0BDA0D30BDAD9B45F2E0D221051E3BB53E 9000 (65) [1 ms]
             Expected: 04C4FE83CD3B4BADD89317A0D24CB15A92604373043B3D999EB475446DB656156EE02589FB8252AA525010CD4FC5C7D2B5C28336192A6F5435560616472E438D6F
             Obtained: 041EB4C36AC69962332EE1AB5DF684B693DF6E220C3BBFA0527A035CAC976E6BE249590269FE030B34A21446C0A0299D0BDA0D30BDAD9B45F2E0D221051E3BB53E
             false (1 ms)
             */
            testAPDU(cardMngr, "B0420000820433C418ABD0ACDB00A7D5D57BFA2084D813BE8E63F99C0954F2041C2E0C2DD5ED40FB5B84C0BDFD16F5CA243422942852438C48CE016751FB0208C6744DE2F75D044EDEBB1CE07F3CA1E1CB0C3ED1F0B6877F709BE567C37C323325CCA9C1E1927854E55A412F53831A970BA0CF8F165EC51BC83C10E95E5F02328F8419A0E40043",
                    "04C4FE83CD3B4BADD89317A0D24CB15A92604373043B3D999EB475446DB656156EE02589FB8252AA525010CD4FC5C7D2B5C28336192A6F5435560616472E438D6F");

            /*
             EC Point Add: 
             --> B042000082046162D8D89DC837B2D542934125D16E087A2ED4CD1909E5277F84E0C50CD8993E4A948DFBC2D8FE71590F84356BCC610DBB2A76AD8C12DCB9202FF4B98880A148041261FBB3E74C0ED2D51CE4E4198EE9ACD0787B92740E28F51C2345AFF98D7A09A81EE6FFF5E353C52D35503B85607BB18777BFF873B57808236F3CE101299C2C
             <-- 04043D62915081A7D614391BCD839A3F9649F8A787DA520B9B64DB3F6AAF88EB35A65B560A89943097F2A74215FD25BD619DB16362A67B9AA89D0D82C4928B5069 9000 (65) [0 ms]
             Expected: 0408B32DAA1CC14F692D5F206EB362A2E200ED4F98D64F5BFD1C585CF0D94FDBB74B5BFA2B982119EC2CEE241AEDE1D33DC3784D104725EA7FF15D8DF8A3268F9A
             Obtained: 04043D62915081A7D614391BCD839A3F9649F8A787DA520B9B64DB3F6AAF88EB35A65B560A89943097F2A74215FD25BD619DB16362A67B9AA89D0D82C4928B5069
             false (0 ms)
             */
            //cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B042000082046162D8D89DC837B2D542934125D16E087A2ED4CD1909E5277F84E0C50CD8993E4A948DFBC2D8FE71590F84356BCC610DBB2A76AD8C12DCB9202FF4B98880A148041261FBB3E74C0ED2D51CE4E4198EE9ACD0787B92740E28F51C2345AFF98D7A09A81EE6FFF5E353C52D35503B85607BB18777BFF873B57808236F3CE101299C2C")));
            testAPDU(cardMngr, "B042000082046162D8D89DC837B2D542934125D16E087A2ED4CD1909E5277F84E0C50CD8993E4A948DFBC2D8FE71590F84356BCC610DBB2A76AD8C12DCB9202FF4B98880A148041261FBB3E74C0ED2D51CE4E4198EE9ACD0787B92740E28F51C2345AFF98D7A09A81EE6FFF5E353C52D35503B85607BB18777BFF873B57808236F3CE101299C2C",
                    "0408B32DAA1CC14F692D5F206EB362A2E200ED4F98D64F5BFD1C585CF0D94FDBB74B5BFA2B982119EC2CEE241AEDE1D33DC3784D104725EA7FF15D8DF8A3268F9A");

            /*
             EC Point Add: 
             --> B042000082041C362ECB030B0B910F75ED5F37FED8EAA2CBA24ECF9A1C93977432E0F0002B64F8176CF7311077272A7DFFD81C736AA3D2B20148242CF203AA7FD4DB260B446F04A50EA35202328E7A005004BE940053F3AF37B9596D26CA4B9F4D774DC66F31E8A63E9D08D6855493CB7F7BDBE163596F7BD3AE13060B249AC37D4E158D0BD5A6
             <-- 048666427C58F6E59225FA389C06C1365648C1100E15FD7316793FD95517F9674B76CCE06B84B32D6D337DDCA6BC54FD54F7CCA53B724C13C5C20FF362B8A52E70 9000 (65) [0 ms]
             Expected: 04D702D8F5FD209A76246FCE0CEDD39384E29768C51091D77ABEEE5754CD5F0B7704CE7F968372F3E1CFA99310F97C5CCB86CF65BEDA2BE23DA7188791A7B4D5A5
             Obtained: 048666427C58F6E59225FA389C06C1365648C1100E15FD7316793FD95517F9674B76CCE06B84B32D6D337DDCA6BC54FD54F7CCA53B724C13C5C20FF362B8A52E70
             false (0 ms)
             */
            testAPDU(cardMngr, "B042000082041C362ECB030B0B910F75ED5F37FED8EAA2CBA24ECF9A1C93977432E0F0002B64F8176CF7311077272A7DFFD81C736AA3D2B20148242CF203AA7FD4DB260B446F04A50EA35202328E7A005004BE940053F3AF37B9596D26CA4B9F4D774DC66F31E8A63E9D08D6855493CB7F7BDBE163596F7BD3AE13060B249AC37D4E158D0BD5A6",
                    "04D702D8F5FD209A76246FCE0CEDD39384E29768C51091D77ABEEE5754CD5F0B7704CE7F968372F3E1CFA99310F97C5CCB86CF65BEDA2BE23DA7188791A7B4D5A5");
            

            // EC Point Add: OK
            testAPDU(cardMngr, "B042000082046C69B918ACCC8799BBA9D1544B351BF88B8CE48E5E7C94EBD8FBFDA2E9598203452D4EB663FE1160ECD40D21DE388C7718469D80BF22E6DF2F22D1591827D71C040E66560F3EDD0D3B4EDF713262ABB3AD27AE0C0DA133DB9BEFB3BE224FDC099F06F9CD081A4D07E77D6E5242A8C9A68EB5A10F5997D0C96187105CAA6B4C655F",
                    "");
            testAPDU(cardMngr, "B04200008204D9CF40DD8DA3426ACBE01E3030AA2553FC19AFEAAC1D729E254C4716B2F2048FE5FA773F9A08315F97B30B07DF9F1D6C0F38DFF63EC0E6CAAD91820FBB374D1E04A5A51D44C5312A6AB3228A3581AF1386956C9E09525CD60CF69FE09A7E2D2C42A47C74726513E6E3368F0BE6859FF3AFAC9F61A48FC27830288BD417D022D710",
                    "");
            testAPDU(cardMngr, "B042000082047BDEC1627643046FD4D05A25515687899F2857D1CCE218BAE0C56F74EE06781F21C849C2EBB2962DA71995450A3AF19F9CE57F48AFB07A3790218F089A4A97D0040523C90A8A9D3DDE94161CBF0EB85A540D174AE07F3DEB61DF0E19E29F0A9CE512AD46063B913693457A6836979308072E1070B7C03B0920828ED4E739945861",
                    "");

            /*
             EC Point Add: 
             --> B042000082046C69B918ACCC8799BBA9D1544B351BF88B8CE48E5E7C94EBD8FBFDA2E9598203452D4EB663FE1160ECD40D21DE388C7718469D80BF22E6DF2F22D1591827D71C040E66560F3EDD0D3B4EDF713262ABB3AD27AE0C0DA133DB9BEFB3BE224FDC099F06F9CD081A4D07E77D6E5242A8C9A68EB5A10F5997D0C96187105CAA6B4C655F
             <-- 04000E224089BC0E39417EB4B765CEC9EBB5BFC7D3E851D79577FA6FEF3A1A37855CFDADB94B8DDD9A788479216AC64009E9D5A3F198941DE08AD133FDCF620D4D 9000 (65) [0 ms]
             Expected: 04860E224189BC0E38417EB4B765CEC9EBB5BFC7D2E851D79577FA6FEF3A1A3786F207180F1E452B6DD3E835CCA1820F9B53B4A258F71A671D0BCE7D19F7AD2F93
             Obtained: 04000E224089BC0E39417EB4B765CEC9EBB5BFC7D3E851D79577FA6FEF3A1A37855CFDADB94B8DDD9A788479216AC64009E9D5A3F198941DE08AD133FDCF620D4D        
             */
            testAPDU(cardMngr, "B042000082046C69B918ACCC8799BBA9D1544B351BF88B8CE48E5E7C94EBD8FBFDA2E9598203452D4EB663FE1160ECD40D21DE388C7718469D80BF22E6DF2F22D1591827D71C040E66560F3EDD0D3B4EDF713262ABB3AD27AE0C0DA133DB9BEFB3BE224FDC099F06F9CD081A4D07E77D6E5242A8C9A68EB5A10F5997D0C96187105CAA6B4C655F",
                    "04860E224189BC0E38417EB4B765CEC9EBB5BFC7D2E851D79577FA6FEF3A1A3786F207180F1E452B6DD3E835CCA1820F9B53B4A258F71A671D0BCE7D19F7AD2F93");
            
            // BUG fixed
            //cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B042000082046C69B918ACCC8799BBA9D1544B351BF88B8CE48E5E7C94EBD8FBFDA2E9598203452D4EB663FE1160ECD40D21DE388C7718469D80BF22E6DF2F22D1591827D71C040E66560F3EDD0D3B4EDF713262ABB3AD27AE0C0DA133DB9BEFB3BE224FDC099F06F9CD081A4D07E77D6E5242A8C9A68EB5A10F5997D0C96187105CAA6B4C655F")));
            /*        EC Point Add: 
             --> B04200008204D9CF40DD8DA3426ACBE01E3030AA2553FC19AFEAAC1D729E254C4716B2F2048FE5FA773F9A08315F97B30B07DF9F1D6C0F38DFF63EC0E6CAAD91820FBB374D1E04A5A51D44C5312A6AB3228A3581AF1386956C9E09525CD60CF69FE09A7E2D2C42A47C74726513E6E3368F0BE6859FF3AFAC9F61A48FC27830288BD417D022D710
             ff02 outof bound
             */
            testAPDU(cardMngr, "B042000082046C69B918ACCC8799BBA9D1544B351BF88B8CE48E5E7C94EBD8FBFDA2E9598203452D4EB663FE1160ECD40D21DE388C7718469D80BF22E6DF2F22D1591827D71C040E66560F3EDD0D3B4EDF713262ABB3AD27AE0C0DA133DB9BEFB3BE224FDC099F06F9CD081A4D07E77D6E5242A8C9A68EB5A10F5997D0C96187105CAA6B4C655F",
                    "");
            
    /*
             EC Point Add: 
             --> B042000082046D8DF86760703C37FB25160368EABB2A988E08489E7AA44349190F38E233BA4929F74D2FCD3664BAA784C20C87B82A6411E66FD53D4BF91DCD6E186FE31A5EF6040E0ED978CC8CE4611171088B7E91B6983D0EE2F4851F34BDC8519186D85F5C9A9C405CE119E295D40755FEF3AE097759C65E6D4ACB4694BEB6554A40E51052BF
             <-- 0459EEA5882826CF1FF557E11528907E234EB2ED23F0BD2F50D03957784BBC00FED608B66C32C999D4587B3DF37847D4E2EE198D47C2B406293291E7901CE5A334 9000 (65) [12297 ms]
             Expected: 0498BF9209C1F8B738D776F1242511C3EE2294F6FA0EFCDC6841E4B6CAB0B1E2C755849BA0AD1BCFBB33845CF686ED4401CA1122E63EE797EB0DE6653A895DEC76
             Obtained: 0459EEA5882826CF1FF557E11528907E234EB2ED23F0BD2F50D03957784BBC00FED608B66C32C999D4587B3DF37847D4E2EE198D47C2B406293291E7901CE5A334
             false (12297 ms)
*/            
            testAPDU(cardMngr, "B042000082046D8DF86760703C37FB25160368EABB2A988E08489E7AA44349190F38E233BA4929F74D2FCD3664BAA784C20C87B82A6411E66FD53D4BF91DCD6E186FE31A5EF6040E0ED978CC8CE4611171088B7E91B6983D0EE2F4851F34BDC8519186D85F5C9A9C405CE119E295D40755FEF3AE097759C65E6D4ACB4694BEB6554A40E51052BF",
                    "0498BF9209C1F8B738D776F1242511C3EE2294F6FA0EFCDC6841E4B6CAB0B1E2C755849BA0AD1BCFBB33845CF686ED4401CA1122E63EE797EB0DE6653A895DEC76");

            /*
             EC scalar_Point Multiplication: 
             scalar: 00C9BA2ED6251A61FFC84D5FDBC1D9977109086645E9DE4A8EA4621E0B19A504E1
             point : 0466EEC756DD194524F8BE1531E55A777DF9D8C919A6FE738CED6D55A0D59B787F1DF45609795171391F26F45B1F31172B65723689E5ED8D08174AC2E781FBB40D
             expect: 04FA5319E41132C2C031462D88B95E8B51EEC334BEBEA3F26EB449D73DE81B606CFFFA95AB76E2FFF7A75E05F378DBCCEF9520DB4B78A9B7786CCE6E18B6D13CBA
             --> B04321006200C9BA2ED6251A61FFC84D5FDBC1D9977109086645E9DE4A8EA4621E0B19A504E10466EEC756DD194524F8BE1531E55A777DF9D8C919A6FE738CED6D55A0D59B787F1DF45609795171391F26F45B1F31172B65723689E5ED8D08174AC2E781FBB40D
             */
            testAPDU(cardMngr, "B04321006200C9BA2ED6251A61FFC84D5FDBC1D9977109086645E9DE4A8EA4621E0B19A504E10466EEC756DD194524F8BE1531E55A777DF9D8C919A6FE738CED6D55A0D59B787F1DF45609795171391F26F45B1F31172B65723689E5ED8D08174AC2E781FBB40D",
                    "04FA5319E41132C2C031462D88B95E8B51EEC334BEBEA3F26EB449D73DE81B606CFFFA95AB76E2FFF7A75E05F378DBCCEF9520DB4B78A9B7786CCE6E18B6D13CBA");
            
    /*        
             EC Point Double:
             -- > B041000041041D1D96E2B171DFCC457587259E28E597258BF86EA0CFCB97BB6FCE62E7539E2879F3FDE52075AACAD1BA7637F816B6145C01E646831C259409FB89309AB03FD9
             javax.smartcardio.CardException: sun.security.smartcardio.PCSCException : Unknown error 0x8010002f
             Expected: 04BEE826372CE4CC0458FF7338E576240BE306CCFA18F83554A5B87FAA81D167DED5425D97120251959AF05BC1BA1BFD92C49726A271B9A6CBACC9E3A7A2145F91
             */
            testAPDU(cardMngr, "B041000041041D1D96E2B171DFCC457587259E28E597258BF86EA0CFCB97BB6FCE62E7539E2879F3FDE52075AACAD1BA7637F816B6145C01E646831C259409FB89309AB03FD9",
                    "");
            
            //EC Point Add:
            //        cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B042000082047BDEC1627643046FD4D05A25515687899F2857D1CCE218BAE0C56F74EE06781F21C849C2EBB2962DA71995450A3AF19F9CE57F48AFB07A3790218F089A4A97D0040523C90A8A9D3DDE94161CBF0EB85A540D174AE07F3DEB61DF0E19E29F0A9CE512AD46063B913693457A6836979308072E1070B7C03B0920828ED4E739945861")));
            testAPDU(cardMngr, "B042000082047BDEC1627643046FD4D05A25515687899F2857D1CCE218BAE0C56F74EE06781F21C849C2EBB2962DA71995450A3AF19F9CE57F48AFB07A3790218F089A4A97D0040523C90A8A9D3DDE94161CBF0EB85A540D174AE07F3DEB61DF0E19E29F0A9CE512AD46063B913693457A6836979308072E1070B7C03B0920828ED4E739945861",
                    "");

            //EC Point Add: (cause x_r to have leading zero)
            //cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B04200008204ACFCFA2F50A4DBF92063014CE6656B323766F5588451EFE364DD1A460FD5FE608518CEBB84B030800821EB7BD87A84F0CE12ADDB6386725016EDB0021104543404F54D175A521FB34F0DD2B01BE00E1500AAD4B77FDF4633D059E14864617E440A71E8CCECC0BD66F6E9690326859E49F089767B7D97A233864A50C77E8EFD950F")));
            testAPDU(cardMngr, "B04200008204ACFCFA2F50A4DBF92063014CE6656B323766F5588451EFE364DD1A460FD5FE608518CEBB84B030800821EB7BD87A84F0CE12ADDB6386725016EDB0021104543404F54D175A521FB34F0DD2B01BE00E1500AAD4B77FDF4633D059E14864617E440A71E8CCECC0BD66F6E9690326859E49F089767B7D97A233864A50C77E8EFD950F",
                    "");
            
            
            //EC Point Add: (cause y_r to have leading zero)
            //cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B04200008204A930A63B0F99734F081363085492B9D8B23E78B020F5F58F7751277AB180C314503A95E75F26BE376B1333271E0A1A2B00A3D4F191697CFE00210620B86EFE4C04B1A72063C23CC6D67468D67FCDBA8719208C06BA98EC71EFA305BFC490A0D0111E12A5F45AC8D8144FB1C063C4645C2ADADDA3BDFD6B49FE125D5FF946F0FAF6")));
            testAPDU(cardMngr, "B04200008204A930A63B0F99734F081363085492B9D8B23E78B020F5F58F7751277AB180C314503A95E75F26BE376B1333271E0A1A2B00A3D4F191697CFE00210620B86EFE4C04B1A72063C23CC6D67468D67FCDBA8719208C06BA98EC71EFA305BFC490A0D0111E12A5F45AC8D8144FB1C063C4645C2ADADDA3BDFD6B49FE125D5FF946F0FAF6",
                    "");

            //EC scalar_Point Multiplication: - causing freeze (solved)
            //         cardMngr.transmit(new CommandAPDU(hexStringToByteArray("B0432000613B9CF893A99F78A70C750CF94544834C5DDF49CFBB51F1AB64BC31560FC4981A0485E1B5D3AE10179BF011090B7DD8380E533A65015EBA63A72F900AEB6FEA4E2B702E87CE6C440A18008353054EA14C96D868A1558AE88131C41F87CD5BCD63F3")));
            //cardMngr.transmit(new CommandAPDU(failedBNSubCommand));
            testAPDU(cardMngr, "B0432000613B9CF893A99F78A70C750CF94544834C5DDF49CFBB51F1AB64BC31560FC4981A0485E1B5D3AE10179BF011090B7DD8380E533A65015EBA63A72F900AEB6FEA4E2B702E87CE6C440A18008353054EA14C96D868A1558AE88131C41F87CD5BCD63F3",
                    "");
    
            /*       
             EC Point Add: Used to be correct response:
             -- > B04200008204E2903869AF98E3C57DFDBB0DC7F6A0031B2AED0DA91E06E7B930DFD6C6C1A5F8706BAFB4604EE70C35934354EC4343044520EE1A4255F4C90F74A28A0B89E22A04B280B8C2E09F93962576C1351E20F18C2FB83FE413A98A736955B4E4FBCF0C3CEDF12D62EA97E27C2EA4B717562F91A14EA4B0602C703F6F2CF1404B5213C320
             < --047AAC87BF2A56E61FE8559E158457E67554567296CDF9916B8C840F7FF88288BA82DD408B4CB5578C971708376E4F596442AEB0BF40886B2C8568920610B05BC6 9000 (65) [7917 ms        ]
             Now incorrectly returns: 
             04011D92032F1C93369AAD6E701F8D8CAC73E2C7D42E9E9BA7B71793E1EE17E7D494CF799FD7AF10DE3BC787975E329D337EDDF6A10C24F77D74DCB6BBE54DB8A2  
             */
            testAPDU(cardMngr, "B04200008204E2903869AF98E3C57DFDBB0DC7F6A0031B2AED0DA91E06E7B930DFD6C6C1A5F8706BAFB4604EE70C35934354EC4343044520EE1A4255F4C90F74A28A0B89E22A04B280B8C2E09F93962576C1351E20F18C2FB83FE413A98A736955B4E4FBCF0C3CEDF12D62EA97E27C2EA4B717562F91A14EA4B0602C703F6F2CF1404B5213C320",
                    "047AAC87BF2A56E61FE8559E158457E67554567296CDF9916B8C840F7FF88288BA82DD408B4CB5578C971708376E4F596442AEB0BF40886B2C8568920610B05BC6");

            /* EC scalar_Point Multiplication: 
             scalar: 0074238D4D6B66ACC8B5C13F95BCFAD391BA183AAECA91426948F08C3321A404D0
             point : 04956587BC0F9FAF4036552905F314528E979ADBA403F9BCFD25933C7079B50E9FF6D08911DB9D33BA8FD002E9281066210D6DB58958153FBEFD85843BC6564BD5
             expect: 04D814007D111A81D1E581007B17D1BE167FE6837AA075C1154FBC13E71EDE8392F4691DB277098F466780699FC08C891CDC94A0F6F8EC59157EC8B86695878235
             correct
             --> B0432100620074238D4D6B66ACC8B5C13F95BCFAD391BA183AAECA91426948F08C3321A404D004956587BC0F9FAF4036552905F314528E979ADBA403F9BCFD25933C7079B50E9FF6D08911DB9D33BA8FD002E9281066210D6DB58958153FBEFD85843BC6564BD5
             <-- 04D814007D111A81D1E581007B17D1BE167FE6837AA075C1154FBC13E71EDE8392F4691DB277098F466780699FC08C891CDC94A0F6F8EC59157EC8B86695878235 9000 (65) [3362 ms]
*/
            testAPDU(cardMngr, "B0432100620074238D4D6B66ACC8B5C13F95BCFAD391BA183AAECA91426948F08C3321A404D004956587BC0F9FAF4036552905F314528E979ADBA403F9BCFD25933C7079B50E9FF6D08911DB9D33BA8FD002E9281066210D6DB58958153FBEFD85843BC6564BD5",
            "04D814007D111A81D1E581007B17D1BE167FE6837AA075C1154FBC13E71EDE8392F4691DB277098F466780699FC08C891CDC94A0F6F8EC59157EC8B86695878235");
            
            
            System.out.print("Disconnecting from card...");
            cardMngr.Disconnect(true);
            System.out.println(" Done.");

            assertTrue(runCfg.failedTestsList.isEmpty(), "Some tests failed");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }        
    
    public void bignat_problemInputs(RunConfig.CARD_TYPE cardType) {
        try {
            // Prepare card
            RunConfig runCfg = RunConfig.getConfig(false, false, false, 1, cardType);
            CardManager cardMngr = new CardManager(true, OPENCRYPTO_UNITTEST_APPLET_AID);
            assertTrue(cardMngr.Connect(runCfg), "Failed to connect to card");
            cardMngr.transmit(new CommandAPDU(PerfTests.PERF_COMMAND_NONE));
            cardMngr.transmit(new CommandAPDU(APDU_CLEANUP));

            //
            // BigNatural 
            // 
            // BN Power2 (Modulo) experimental implementation:  
            testAPDU(cardMngr, "B0352020409A8FC09A678E50872FC4A1A138F99F655C6D4FE56EDC6D301056CE6C674CE0DE8FEDC2AF0D510008F4FE592404DDCFC38B3BE8C38FF39D564F81E1869B0D5E1B",
                    "56cc407db4a3d466aa3539ca3b66ab803a06f540eea79c77357a89a2e76b1169");
            testAPDU(cardMngr, "B0352020407C3C6538457F6C63C5912D04BA113F7171DEF28463A4196D6334CB5D88D12AC954BD2644639814328A4F60FB3E45087648D87985C7ED1E8346BA3F5ECFF63250",
                    "29369d2b579f166b2ff947df96bf8a0ff4675905415c64fcee91983ebac5d6d1");
            testAPDU(cardMngr, "B0352020406C87246CB00816779431C182084C30C769B1A04C6C8743F8160681B703C58D68C58A50BA1B8A9DF2A64EE81AE54D1C3C1D7E3ECF78B29D3FF294060335D2677E",
                    "513D96CB8AD8F44AE0447E0C2E2BC687AFF2139D4C561576036F12DE9350402E");
            testAPDU(cardMngr, "B0352020405F152D45F30A25237509F42D5EC3B01D9864835C1795ABA3E0ADF0452F60DD0113D154FC2548A9269B24BA617866F68588DF9B4AB17FF1015F96434BB52C915E",
                    "0d2168149af362b3b2efe09ec9c9d8fe463675ca3c844db149ccb3c4ba3d0b61");
            testAPDU(cardMngr, "B035202040D129C0794C0E4412E14C63907C142DFAFC97688EB1F53FCF9AAF466B06CC325EDC8FA4439BCD8E3F6392CB345A52BE128553F51E6BDFEA4E16CCB171B7B49C65",
                    "1492eec916bd16177f35b6e36c66139a58772d7cebe2ca6790020bf003f6c6d9");
            testAPDU(cardMngr, "B035202040E98E1277553A77AE51944A1F4C5CA0EE431CB1616F73B26A57E997A61FD4D7283A2EF0F52311B5C4156DAB4604306AA3621ADBEEC01654C1A34053CA936BB571",
                    "011AD0B74B558E2FCF1CCA035828993E45295861E5842CABA54EC8C4B956D226");
            testAPDU(cardMngr, "B03520204024B7BB2271FA9E0FD4D10A2E7F9594E660034863E103020EC1B1ACC14BE2A5C50F0C4063305383E4578E076527227D25A7CCB7B9BA631627D53C114115FF0663",
                    "");

            // BigNatural Inversion (Modulo)
            testAPDU(cardMngr, "B034300050B70EF3C6B8397C093E403D0BE1230557A0B701103DB659ED5AF81A841120C323D7C01C8BC7A2B42D7ECC22B37DEF7B5BFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF",
                    "8EC0632A4E35CE9F1E45A35A9DCB2EDD546973D16D9A12D2BBA193DBF2754EFC");

            // BigNatural Exponentiation: B0240100020E08 fails with FF02
            testAPDU(cardMngr, "B0240100020E08",
                    "");
            // BigNatural Exponentiation (Modulo): (reintroduced problem with jcardsim trimmming of result with leading zeroes)
            testAPDU(cardMngr, "B033200141AF830BDC53A63B531030870D7B065223CC837DE4F9EB59C5FEAD4FBA7EBFF1A50203BC5F27F2EFE641CB11AF114A0CEFE680792A02425A257472B5F14235ADAD83",
                    "509360e9092835050296e07edae32577cc85aa5b2826545749c2d1f7a87abf");

            // SQRT: this input will call mod_exp() with this to be zero => subsequent problem in shrink()
            testAPDU(cardMngr, "B02620002000DF0EFC062866435464C1BCBF84D63A4A0FCB014E0D99666152F582787DEF78",
                    "");

            // BigNatural Exponentiation (Modulo): 
            testAPDU(cardMngr, "B0332001410DE9847BA48DB897190C7DAA01B671035D2F5D3C3AA4C4C42EE373D4551E023902C5F01D0548C751376E587A019ACC1FEFA2332E535804C78CEDF43806E6B73351",
                    "0778b9572a6a589a7c5a2a2004862b0365e5d8af57839644e8f58d427c2eb784");

            // BigNatural Exponentiation (Modulo): 
            testAPDU(cardMngr, "B03320014104E83559CB11AA9E4FC4E9BD30A7561B16C4FA35A0E1FD9E928EB9B131474CBD02D896150E59B429E89E54C116E51FD8D5FE71090C80472FFC7D8C652D65A509E5",
                    "d3cd532b396dd52ac64affd1bfee9790912e867735941d75a163102e0ce7aa");
            testAPDU(cardMngr, "B03320013FC509E0ABDD401F1586F88627866AFD469CB6FD1380B53ACF200E22FA7E4810EF0235FD5AAAD2ADB623BE5DCF80D67E603F269E568F6F1C3BBD6A8627EC3140",
                    "");

            /* BigNatural Exponentiation (Modulo): 
             num1: 9a8c640610ba423c257ac4b839b82966ff92ab183a3b16cfc4b2a8884d546ed
             num2: 2
             num3: eaf125899a9f23872f816450608837ba204fe6c1cd524fb208532a870d76
             --> B03320013F09A8C640610BA423C257AC4B839B82966FF92AB183A3B16CFC4B2A8884D546ED02EAF125899A9F23872F816450608837BA204FE6C1CD524FB208532A870D76
             <-- 25BB994E37B9A731D460D523016F08D9ADAB2A4911A4F6D8C0CF0F66A738 9000 (30) [3725 ms]
             Expected: 6343776f5b72dca439def7270bbae68b5f4f60840bb05e95f443e5006055
             Obtained: 25bb994e37b9a731d460d523016f08d9adab2a4911a4f6d8c0cf0f66a738
             false
             */
            testAPDU(cardMngr, "B03320013F09A8C640610BA423C257AC4B839B82966FF92AB183A3B16CFC4B2A8884D546ED02EAF125899A9F23872F816450608837BA204FE6C1CD524FB208532A870D76",
                    "6343776F5B72DCA439DEF7270BBAE68B5F4F60840BB05E95F443E5006055");

            System.out.print("Disconnecting from card...");
            cardMngr.Disconnect(true);
            System.out.println(" Done.");

            assertTrue(runCfg.failedTestsList.isEmpty(), "Some tests failed");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }    

    @Test
    public void openCrypto_ECExample() throws Exception {
        RunConfig runCfg = RunConfig.getConfig(false, false, false, 1, RunConfig.CARD_TYPE.JCARDSIMLOCAL);
        //RunConfig runCfg = RunConfig.getConfig(false, false, false, 1, RunConfig.CARD_TYPE.PHYSICAL);
        runCfg.appletToSimulate = ECExample.class;
        CardManager cardMngr = new CardManager(true, OPENCRYPTO_UNITTEST_APPLET_AID);
        assertTrue(cardMngr.Connect(runCfg), "Failed to connect to card");
        cardMngr.transmit(new CommandAPDU(PerfTests.PERF_COMMAND_NONE));
        cardMngr.Disconnect(true);
    }    
    
    @BeforeClass
    public static void setUpClass() throws Exception {
    }

    @AfterClass
    public static void tearDownClass() throws Exception {
    }

    @BeforeMethod
    public void setUpMethod() throws Exception {
    }

    @AfterMethod
    public void tearDownMethod() throws Exception {
    }
}
